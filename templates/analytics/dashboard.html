{% extends "shared/base.html" %}

{% block content %}
<div class="space-y-12 animate-[fadeIn_0.5s_ease-out]">

    <!-- Header -->
    <div class="border-b border-gold-dim/20 pb-8">
        <h2 class="text-4xl font-serif text-gold italic mb-2">The Ledger</h2>
        <p class="text-stone-500 font-mono text-xs uppercase tracking-widest">Analytics & Insights</p>
    </div>

    <!-- 1. KPI Cards (Row) -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
        <!-- Total Value -->
        <div class="classic-panel p-6 rounded-lg space-y-2">
            <p class="text-[10px] font-bold text-stone-500 uppercase tracking-widest">Asset Value</p>
            <h3 class="text-3xl font-serif text-gold-light">${{ "{:,.2f}".format(stats.total_value) }}</h3>
        </div>

        <!-- Total Count -->
        <div class="classic-panel p-6 rounded-lg space-y-2">
            <p class="text-[10px] font-bold text-stone-500 uppercase tracking-widest">Total Sticks</p>
            <h3 class="text-3xl font-serif text-parchment">{{ stats.total_count }}</h3>
        </div>

        <!-- Unique Brands -->
        <div class="classic-panel p-6 rounded-lg space-y-2">
            <p class="text-[10px] font-bold text-stone-500 uppercase tracking-widest">Unique Brands</p>
            <h3 class="text-3xl font-serif text-parchment">{{ stats.unique_brands }}</h3>
        </div>

        <!-- Avg Rating -->
        <div class="classic-panel p-6 rounded-lg space-y-2">
            <p class="text-[10px] font-bold text-stone-500 uppercase tracking-widest">Avg Rating</p>
            <h3 class="text-3xl font-serif text-amber-400">{{ stats.avg_rating }}<span
                    class="text-base text-stone-600">/100</span></h3>
        </div>
    </div>

    <!-- 2. Charts Section -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

        <!-- Chart: Origins (Doughnut) -->
        <div class="classic-panel p-6 rounded-lg">
            <h4 class="text-lg font-serif text-gold-dim mb-6">Terroir (Origin)</h4>
            <div class="relative h-64 w-full">
                <canvas id="originChart"></canvas>
            </div>
        </div>

        <!-- Chart: Top Brands (Bar) -->
        <div class="classic-panel p-6 rounded-lg">
            <h4 class="text-lg font-serif text-gold-dim mb-6">Preferred Ateliers (Brands)</h4>
            <div class="relative h-64 w-full">
                <canvas id="brandChart"></canvas>
            </div>
        </div>

        <!-- Chart: Top Smoked (Bar) -->
        <div class="classic-panel p-6 rounded-lg lg:col-span-2">
            <h4 class="text-lg font-serif text-gold-dim mb-6">Most Consumed (Sessions)</h4>
            <div class="relative h-64 w-full">
                <canvas id="topSmokedChart"></canvas>
            </div>
        </div>
    </div>

</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // Common Config
    Chart.defaults.color = '#a8a29e';
    Chart.defaults.font.family = 'ui-serif, Georgia, Cambria, "Times New Roman", Times, serif';

    const goldColor = '#d4af37';
    const goldDim = '#8a7e5f';
    const leatherDark = '#1a0f0a';
    const parchment = '#f0e6d2';

    // 1. Origin Chart
    const ctxOrigin = document.getElementById('originChart').getContext('2d');
    new Chart(ctxOrigin, {
        type: 'doughnut',
        data: {
            labels: {{ charts.origins.labels | safe }},
        datasets: [{
            data: {{ charts.origins.data | safe }},
        backgroundColor: [
            '#d4af37', // Gold
            '#8a7e5f', // Gold Dim
            '#5c5443', // Darker Gold
            '#f0e6d2', // Parchment
            '#3f352b'  // Leather Light
        ],
        borderWidth: 0
            }]
        },
        options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { position: 'right' }
        }
    }
    });

    // 2. Brand Chart
    const ctxBrand = document.getElementById('brandChart').getContext('2d');
    new Chart(ctxBrand, {
        type: 'bar',
        data: {
            labels: {{ charts.brands.labels | safe }},
        datasets: [{
            label: 'Cigars in Humidor',
            data: {{ charts.brands.data | safe }},
        backgroundColor: goldColor,
        borderRadius: 2
            }]
        },
        options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: { beginAtZero: true, grid: { color: '#3f352b' } },
            x: { grid: { display: false } }
        },
        plugins: { legend: { display: false } }
    }
    });

    // 3. Top Smoked Chart
    const ctxTop = document.getElementById('topSmokedChart').getContext('2d');
    new Chart(ctxTop, {
        type: 'bar',
        data: {
            labels: {{ charts.top_smoked.labels | safe }},
        datasets: [{
            label: 'Sessions Logged',
            data: {{ charts.top_smoked.data | safe }},
        backgroundColor: parchment,
        borderRadius: 2,
        barThickness: 20
            }]
        },
        options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            x: { beginAtZero: true, grid: { color: '#3f352b' } },
            y: { grid: { display: false } }
        },
        plugins: { legend: { display: false } }
    }
    });
</script>
{% endblock %}